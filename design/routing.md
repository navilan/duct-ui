# Rendering

In order for Duct to be served, it needs to support server side rendering and static site generation. To keep it simple, the initial
version of duct shall support generation for cloudflare.

# Static Site Generation & Cloudflare Worker Generation

 We wan't to piggy back on the very capable vite. The strategy would be to have file based routing and a vite plugin to generate static sites.

 Every route will have the following structure:

```
- pages
|-- <route>
  |-- index.tsx - the page component
  |-- sub.tsx - the template component
|-- layouts
  |-- shell.html - A templated shell
```

 For each of the routes that have index.tsx and [path].tsx, the vite plugin will generate a html file. For each [[catchall]].tsx the
 cloudflare worker will be updated to return the default export as the component.

## Rendering strategy

### Layouts

* Layouts are html shells using nunjucks template language expecting a {page} template context variable

### Page Components

Each page component will have:

* a getLayout function that returns the path of the layout file relative to the layouts directory
* a getPageContext function that returns the `page` variable for the shell layout
* a default export that returns a duct component to be rendered in the `app` container

#### Sub Paths

In addition to the standard results of the page component, the sub.tsx file will have:

* a getRoutes function that returns an array of paths to be generated statically
* an asynchronous fallback function that will be used as the fallback renderer in the generated cloudflare worker

## Vite Plugin

The vite plugin will loop through the pages to issue entry points for vite to generate.

## Worker

A cloudflare worker will be generated by the duct cli to serve the fallback routes.

## Development strategy

Cloudflare's wrangler will be used to provide a development server (perhaps in combination with vite dev server?).

## Development Server

For the development server, we need to generate the static site up to the point of having a html directory on `buildStart`, the final vite compilation is not needed. Perhaps we can create a vite plugin that calls the duct cli as an external process on `buildStart`. Then when paths are being resolved the plugin must return the content from the html directory.
